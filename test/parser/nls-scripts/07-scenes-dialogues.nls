// 07-scenes-dialogues.nls
// Scenes and dialogues test script covering characters, scenes, dialogues, narration
// åœºæ™¯å’Œå¯¹è¯æµ‹è¯•è„šæœ¬ï¼Œæ¶µç›–è§’è‰²ã€åœºæ™¯ã€å¯¹è¯ã€æ—ç™½ç­‰

// ===== è§’è‰²å®šä¹‰æµ‹è¯• =====
// Character definition tests

// åŸºç¡€è§’è‰²å®šä¹‰
character John "John Smith"
character Alice "Alice Johnson"
character Bob "Bob Wilson"

// å¸¦æè¿°çš„è§’è‰²å®šä¹‰
character Narrator "Story Narrator"
character Mysterious "???"

// åŠ¨æ€è§’è‰²å®šä¹‰
set characterName "Dynamic Character"
character DynamicChar characterName

// ===== å›¾ç‰‡å’Œèµ„æºå®šä¹‰æµ‹è¯• =====
// Image and resource definition tests

// è§’è‰²å›¾ç‰‡å®šä¹‰
image John "john.png" pos (50%, 50%) scale 0.8
image Alice "alice.png" pos (30%, 60%) scale 1.0
image Bob "bob_happy.png" pos (70%, 40%) scale 0.9

// èƒŒæ™¯å›¾ç‰‡
image Background "sunset_bg.png"
image RoomBg "room_interior.jpg"

// åŠ¨æ€å›¾ç‰‡è·¯å¾„
set imageFolder "assets/characters/"
set johnImagePath imageFolder + "john_default.png"
image JohnDynamic johnImagePath pos (50%, 50%)

// ===== åŸºç¡€åœºæ™¯æµ‹è¯• =====
// Basic scene tests

// ç®€å•åœºæ™¯
scene IntroScene(
    bg "intro_bg.png"
) {
    "Welcome to NarraLang test scenes!"
    
    show John duration 1.0
    John: "Hello, I'm John. Welcome to our test!"
    
    show Alice duration 1.0
    Alice: "Hi there! I'm Alice."
    
    hide John duration 0.5
    hide Alice duration 0.5
}

// å¸¦å‚æ•°çš„åœºæ™¯
scene DialogueScene(
    bg "room_bg.png",
    music "background_music.mp3"
) {
    "The two friends met in a cozy room."
    
    show John duration 1.0
    show Alice duration 1.0 
    
    John: "It's nice to see you again, Alice."
    Alice: "Likewise, John! How have you been?"
    
    John: {
        "I've been working on some interesting projects."
        "One of them is this new language called NarraLang."
        "It's designed specifically for interactive storytelling."
    }
    
    Alice: "That sounds fascinating! Tell me more about it."
}

// ===== å¤æ‚å¯¹è¯æµ‹è¯• =====
// Complex dialogue tests

scene ComplexDialogueScene(
    bg "library_bg.png"
) {
    // åœºæ™¯è®¾ç½®
    set currentTime "afternoon"
    set location "library"
    set mood "peaceful"
    
    "It was a {mood} {currentTime} in the {location}."
    
    show John duration 1.0
    show Alice duration 1.0
    
    // å¸¦æ’å€¼çš„å¯¹è¯
    set bookCount 15
    Alice: "I've read {bookCount} books this month!"
    
    // è¡¨è¾¾å¼æ’å€¼
    John: "That's {bookCount > 10 ? 'impressive' : 'decent'}! I've only read {Math.floor(bookCount / 3)} myself."
    
    // æ¡ä»¶å¯¹è¯
    if bookCount > 10 {
        Alice: "I've been on a reading streak lately."
    } else {
        Alice: "I should read more books."
    }
    
    // åŠ¨æ€è§’è‰²é€‰æ‹©
    set speaker bookCount > 10 ? Alice : John
    speaker: "Reading is such a wonderful hobby."
    
    // ä¸´æ—¶è§’è‰²
    "Librarian": "Excuse me, the library will be closing soon."
    
    John: "Thank you for letting us know."
    Alice: "We should probably head out then."
    
    hide John duration 1.0
    hide Alice duration 1.0
}

// ===== å¯Œæ–‡æœ¬å¯¹è¯æµ‹è¯• =====
// Rich text dialogue tests

scene RichTextScene(
    bg "magic_forest.png"
) {
    show Mysterious duration 2.0
    
    // åŸºç¡€æ ·å¼æ ‡ç­¾
    Mysterious: "Welcome to the <b>Enchanted Forest</b>."
    Mysterious: "Here, <i>magic</i> flows through everything."
    
    // é¢œè‰²æ ‡ç­¾
    Mysterious: "You can see <red>fire sprites</red> and <blue>water elementals</blue> here."
    Mysterious: "The <#00ff00>emerald trees</> shimmer in the moonlight."
    
    // åµŒå¥—æ ·å¼
    Mysterious: "The most <b><i>powerful magic</i></b> lies deep within."
    Mysterious: "Be careful of the <red><b>dangerous creatures</b></red> that lurk about."
    
    // åœé¡¿æ ‡ç­¾
    Mysterious: "There is something you must know<pause duration={2000} />but I cannot tell you directly."
    Mysterious: "You must discover it<pause />for yourself."
    
    // Rubyæ³¨éŸ³
    Mysterious: "The ancient word is <p ruby="ã¾ã»ã†">é­”æ³•</p>."
    
    // è‡ªå®šä¹‰å•è¯
    Mysterious: "Listen carefully to this <p cps=0.5>very important message</p>."
    
    hide Mysterious duration 2.0
}

// ===== å¤šè¡Œå¯¹è¯å’Œæ—ç™½æµ‹è¯• =====
// Multi-line dialogue and narration tests

scene NarrationScene(
    bg "storyteller_room.png"
) {
    // å¤šè¡Œæ—ç™½
    "Once upon a time, in a land far, far away, there lived a young programmer."
    "This programmer had a dream: to create a language that could tell stories."
    "Little did they know that their dream would soon become reality."
    
    show Narrator duration 1.0
    
    // è§’è‰²å¤šè¡Œå¯¹è¯
    Narrator: {
        "Let me tell you about the three fundamental principles of storytelling."
        "First, every story needs compelling characters."
        "Second, there must be conflict or challenge to overcome."
        "Third, the story should have a satisfying resolution."
    }
    
    // nullè§’è‰²å¤šè¡Œå¯¹è¯ï¼ˆæ—ç™½å½¢å¼ï¼‰
    null: {
        "The narrator paused, looking thoughtful."
        "The room fell silent as the weight of these words settled in."
        "Then, slowly, a smile spread across their face."
    }
    
    Narrator: "Now, let's see these principles in action!"
    
    hide Narrator duration 1.0
}

// ===== äº¤äº’å¼å¯¹è¯æµ‹è¯• =====
// Interactive dialogue tests

scene InteractiveScene(
    bg "decision_point.png"
) {
    set playerName "Hero"
    set playerLevel 5
    set hasKey false
    
    show John duration 1.0
    
    John: "Welcome, {playerName}! I see you're level {playerLevel}."
    
    // æ¡ä»¶åˆ†æ”¯å¯¹è¯
    if playerLevel >= 5 {
        John: "You're experienced enough for this quest."
        set hasKey true
    } else {
        John: "You might want to gain more experience first."
    }
    
    // åŸºäºçŠ¶æ€çš„å¯¹è¯
    if hasKey {
        John: "Here, take this key. You'll need it."
        "John hands you a mysterious golden key."
    } else {
        John: "Come back when you're stronger."
    }
    
    // æ¨¡æ‹Ÿé€‰æ‹©ç»“æœ
    set playerChoice "accept"
    
    if playerChoice is "accept" {
        John: "Excellent! Your adventure begins now."
    } else {
        John: "I understand. Take your time to decide."
    }
    
    hide John duration 1.0
}

// ===== åœºæ™¯å˜é‡å’ŒçŠ¶æ€æµ‹è¯• =====
// Scene variables and state tests

scene StateManagementScene(
    bg "village.png"
) {
    // å±€éƒ¨åœºæ™¯å˜é‡
    local set villagePopulation 150
    local set mayorName "Elder Thompson"
    local set isMarketDay true
    
    "Welcome to our small village."
    
    if isMarketDay {
        "Today is market day, and the village is bustling with activity."
        "You can see {villagePopulation} villagers going about their business."
    } else {
        "The village is quiet today."
    }
    
    show John duration 1.0
    John: "Hello, traveler! I'm John, one of the villagers here."
    
    // ä½¿ç”¨å±€éƒ¨å˜é‡
    John: "Our mayor, {mayorName}, is always welcoming to visitors."
    John: "We have {villagePopulation} people living here."
    
    // ä¿®æ”¹å±€éƒ¨å˜é‡
    if isMarketDay {
        add 20 to villagePopulation  // å¸‚åœºæ—¥æœ‰è®¿å®¢
        John: "With all the visitors today, we have about {villagePopulation} people in town."
    }
    
    hide John duration 1.0
}

// ===== åœºæ™¯é—´çš„å˜é‡ä½œç”¨åŸŸæµ‹è¯• =====
// Inter-scene variable scope tests

// å…¨å±€å˜é‡
set globalStoryProgress 0
set globalPlayerName "TestPlayer"

scene FirstScene(bg "start.png") {
    set globalStoryProgress 1
    
    show Alice duration 1.0
    Alice: "Hello, {globalPlayerName}! Your journey begins here."
    Alice: "Story progress: {globalStoryProgress}"
    hide Alice duration 1.0
}

scene SecondScene(bg "middle.png") {
    // è®¿é—®å…¨å±€å˜é‡
    Alice: "Welcome back, {globalPlayerName}!"
    Alice: "I see you've made progress: {globalStoryProgress}"
    
    // ä¿®æ”¹å…¨å±€å˜é‡
    set globalStoryProgress 2
    Alice: "You're now at stage {globalStoryProgress}."
}

// ===== åŠ¨æ€åœºæ™¯ç”Ÿæˆæµ‹è¯• =====
// Dynamic scene generation tests

function! createDynamicScene(sceneName, background, characters) {
    // è¿™æ˜¯ä¸€ä¸ªæ¨¡æ‹ŸåŠ¨æ€åœºæ™¯åˆ›å»ºçš„å®å‡½æ•°
    console.log("Creating scene: " + sceneName)
    console.log("Background: " + background)
    console.log("Characters: " + characters.join(", "))
}

set sceneConfig {
    name: "DynamicTestScene",
    background: "dynamic_bg.png",
    characters: ["John", "Alice", "Bob"]
}

createDynamicScene sceneConfig.name background sceneConfig.background

// ===== åœºæ™¯æµç¨‹æ§åˆ¶æµ‹è¯• =====
// Scene flow control tests

scene FlowControlScene(bg "control_room.png") {
    set step 1
    
    loop 3 times {
        "This is step {step} of the process."
        add 1 to step
    }
    
    show John duration 1.0
    
    // åœºæ™¯ä¸­çš„æ¡ä»¶æ§åˆ¶
    set timeOfDay "morning"
    
    if timeOfDay is "morning" {
        John: "Good morning! Ready to start the day?"
    } else if timeOfDay is "afternoon" {
        John: "Good afternoon! How's your day going?"
    } else {
        John: "Good evening! Almost time to rest."
    }
    
    // åœºæ™¯ä¸­çš„å˜é‡æ“ä½œ
    set taskCount 0
    
    loop 5 times {
        add 1 to taskCount
        if taskCount is 3 {
            John: "We're halfway through our tasks!"
        }
    }
    
    John: "All {taskCount} tasks completed!"
    
    hide John duration 1.0
}

// ===== ç‰¹æ®Šå¯¹è¯æ ¼å¼æµ‹è¯• =====
// Special dialogue format tests

scene SpecialFormatsScene(bg "experiment_lab.png") {
    // è¡¨è¾¾å¼ä½œä¸ºè§’è‰²å
    set speakerIndex 0
    set speakers ["John", "Alice", "Bob"]
    
    speakers[speakerIndex]: "I'm speaker number {speakerIndex}!"
    
    set speakerIndex 1
    speakers[speakerIndex]: "Now I'm speaker number {speakerIndex}!"
    
    // è®¡ç®—å±æ€§ä½œä¸ºè§’è‰²å
    set prefix "Dr. "
    set suffix " Smith"
    (prefix + "John" + suffix): "I'm a doctor!"
    
    // æ¡ä»¶è§’è‰²å
    set isFormal true
    (isFormal ? "Professor John" : "John"): "Greetings!"
    
    // åŠ¨æ€ç”Ÿæˆçš„å¯¹è¯å†…å®¹
    set inventory ["sword", "shield", "potion"]
    set itemCount inventory.length()
    
    John: "I have {itemCount} items: {inventory.join(', ')}."
    
    // å¤æ‚è¡¨è¾¾å¼æ’å€¼
    set baseHealth 100
    set damage 25
    set healingPortion 15
    
    Alice: "Health: {baseHealth - damage + healingPortion}/{baseHealth} ({Math.round((baseHealth - damage + healingPortion) / baseHealth * 100)}%)"
}

// ===== åœºæ™¯åµŒå¥—å’Œæ¨¡å—åŒ–æµ‹è¯• =====
// Scene nesting and modularization tests

scene MainStoryScene(bg "main_story.png") {
    "This is the main story scene."
    
    // æ¨¡æ‹Ÿè°ƒç”¨å­åœºæ™¯æˆ–æ¨¡å—
    function! playSubSequence(sequenceName) {
        console.log("Playing subsequence: " + sequenceName)
        
        if sequenceName is "introduction" {
            show John duration 1.0
            John: "Let me introduce myself."
            hide John duration 1.0
        } else if sequenceName is "conflict" {
            show Alice duration 1.0
            Alice: "There seems to be a problem we need to solve."
            hide Alice duration 1.0
        } else if sequenceName is "resolution" {
            show John duration 1.0
            show Alice duration 1.0
            John: "I think we found the solution!"
            Alice: "Great work, John!"
            hide John duration 1.0
            hide Alice duration 1.0
        }
    }
    
    playSubSequence "introduction"
    playSubSequence "conflict"
    playSubSequence "resolution"
    
    "The story concludes successfully."
}

// ===== é”™è¯¯å¤„ç†å’Œè¾¹ç•Œæƒ…å†µæµ‹è¯• =====
// Error handling and edge cases tests

scene EdgeCaseScene(bg "test_environment.png") {
    // ç©ºå­—ç¬¦ä¸²å¯¹è¯
    John: ""
    
    // åªæœ‰ç©ºæ ¼çš„å¯¹è¯
    Alice: "   "
    
    // æé•¿çš„å¯¹è¯
    set longText "This is a very long piece of dialogue that tests how the system handles extended text. ".repeat(10)
    Bob: longText
    
    // Unicodeå­—ç¬¦å¯¹è¯
    Mysterious: "Unicode test: ğŸ®ğŸ¯ğŸ² Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ñ€ÑƒÑÑĞºĞ¸Ğ¹ æ—¥æœ¬èª"
    
    // ç‰¹æ®Šå­—ç¬¦
    John: "Special chars: !@#$%^&*()_+-={}[]|\\:;\"'\<\>,.?/"
    
    // æ•°å­—ä½œä¸ºå­—ç¬¦ä¸²
    Alice: "Numbers as text: 123456789"
    
    // å¸ƒå°”å€¼æ’å€¼
    set isActive true
    Bob: "Status is {isActive ? 'active' : 'inactive'}"
    
    // nullå€¼å¤„ç†
    set nullValue null
    John: "Null value: {nullValue ?? 'N/A'}"
}

// æµ‹è¯•å®Œæˆæ ‡è®°
set scenesDialoguesTestCompleted true

"Scenes and dialogues test completed successfully"
