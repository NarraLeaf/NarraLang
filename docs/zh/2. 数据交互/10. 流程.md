# 2.10 流程

流程（procedure）是NLang最基础的特性，用于装载多个表达式或语句。

流程作为类型，可以被传入到函数和语法糖中作为参数。_你无法显式构建这个类型_。

## 流程

流程中可以包含任何表达式。其中，字符串表达式会被转换为旁白。

```javascript
character John "John"

scene Scene1 {
    set num 1
    set str "Hello"

    John: Hello!

    "这是一句旁白"

    set arr []
    arr.add(1) // 函数调用
}
```

### 流程控制流

流程中无法使用大部分控制流。使用这些控制流会导致解析错误。

```javascript
scene Scene1 {
    set arr [1, 2, 3]

    for each item in arr {} // Error: Cannot use `for` in procedure
}
```

流程可以使用的控制流包括：`if`, `else`, `loop`  
流程无法使用的控制流包含但不限于：`while`, `for`, `break`, `continue`, `return`

```javascript
scene Scene1 {
    set num 1

    loop 10 times {
        John: 这句话会执行10次，这是第{num}次

        add 1 to num
    }
}
```

### 作用域

流程本身**不具有独立作用域**。在NLang中，只有**场景**和**函数**具有独立作用域。

```javascript
scene Scene1 {
    {
        set num 1
    }

    num // 1
}
```

## 与函数的差异

流程和函数是两种不同的组织代码的方式。

流程主要组织异步的故事脚本，包括**展示对话框、向图片应用变换和创建选项**。流程无法被直接执行，但流程中能嵌套流程。  
函数主要执行复杂的运算操作，例如**迭代、计算和条件判断**。函数可以作为表达式在任何流程和函数中执行。

这一设计源于NarraLeaf的动作执行特性：浏览器环境、无副作用和静态脚本树生成。

由于流程绝对静态的特性，我们无法通过动态变量来决定某个脚本树节点执行的次数。流程会被转换为实际操作调用，而不是JavaScript代码。  
为了执行复杂的计算，我们引入了函数概念。和传统函数不同，NLang的函数被设计为同步并且无副作用的。这是因为函数会被转换为实际JavaScript代码，而JavaScript代码的动态影响力会对静态脚本树造成影响。为了防止这一点发生，函数无法包含影响脚本树（场景动作）的代码，并且应该能够在代码执行多次时（用户撤销操作）不产生副作用。

即便如此，NLang依旧提供了宏函数这个强大的特性。通过宏函数，编写者可以执行实际具有副作用和异步代码的函数。

> 这也是宏函数无法使用括号操作符调用的原因。  
> 由于宏函数必须在脚本树中占据位置以暂停脚本树执行（异步任务）并且注册副作用清理，因此宏函数无法被以表达式的形式行内直接调用。

## 下一步

下一章节：[控制流](./11.%20控制流.md)
